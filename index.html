<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>INDEX | Integrated Elite</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <style>
        :root { --gold: #d4af37; --bg: #020617; --glass: rgba(255, 255, 255, 0.03); --border: rgba(212, 175, 55, 0.15); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #e2e8f0; overflow: hidden; transition: background 0.5s; }

        .screen { position: fixed; inset: 0; display: none; flex-direction: column; background: var(--bg); z-index: 100; padding: 30px; }
        .active-screen { display: flex; align-items: center; justify-content: center; }

        .card { background: #000; border: 1px solid var(--gold); padding: 30px; border-radius: 20px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 0 30px rgba(212, 175, 55, 0.1); }
        input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(255,255,255,0.03); color: white; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--gold); }
        .btn-gold { background: linear-gradient(90deg, #d4af37, #f5d17a); color: black; border: none; padding: 15px; border-radius: 12px; font-weight: 800; cursor: pointer; width: 100%; text-transform: uppercase; }

        /* Profile & User List */
        .profile-list { width: 100%; max-height: 200px; overflow-y: auto; margin: 15px 0; }
        .profile-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--glass); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 8px; cursor: pointer; }
        .user-list { flex: 1; overflow-y: auto; padding: 20px; }
        .user-row { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--glass); border-radius: 18px; margin-bottom: 10px; cursor: pointer; border: 1px solid transparent; }
        .user-row:hover { border-color: var(--gold); }

        /* App Header & Navigation */
        .app-header { padding: 50px 20px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .header-btn { background: var(--glass); border: 1px solid var(--border); color: var(--gold); width: 40px; height: 40px; border-radius: 10px; cursor: pointer; }

        /* Private DM Overlay */
        #dmOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: none; flex-direction: column; }
        #dmBox { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 12px 16px; border-radius: 20px; position: relative; font-size: 0.9rem; }
        .sent { align-self: flex-end; background: var(--gold); color: black; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: var(--glass); border: 1px solid var(--border); border-bottom-left-radius: 2px; }
        .input-bar { padding: 15px 20px 40px; display: flex; gap: 10px; background: rgba(0,0,0,0.6); }
        .circle-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--gold); border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="pinScreen" class="screen active-screen">
        <div class="card">
            <h1 style="font-family:'Cinzel'; color:var(--gold)">INDEX</h1>
            <input type="password" id="appPin" placeholder="4-DIGIT PIN" maxlength="4" style="text-align:center; font-size:1.5rem;">
            <button class="btn-gold" onclick="verifyPin()">UNSEAL NODE</button>
        </div>
    </div>

    <div id="authScreen" class="screen">
        <div class="card">
            <h2 id="authTitle" style="color:var(--gold)">CAMPUS LOGIN</h2>
            <input type="email" id="authEmail" placeholder="GMAIL">
            <input type="password" id="authPass" placeholder="PASSWORD">
            <button class="btn-gold" onclick="handleAuth()">AUTHENTICATE</button>
            <p onclick="toggleAuthMode()" id="toggleText" style="font-size:0.8rem; color:var(--gold); margin-top:15px; cursor:pointer;">New Student? Register</p>
        </div>
    </div>

    <div id="profileScreen" class="screen">
        <div class="card">
            <h2 style="color:var(--gold)">IDENTITIES</h2>
            <div id="profileList" class="profile-list"></div>
            <input type="text" id="newUsername" placeholder="NEW USERNAME">
            <button class="btn-gold" onclick="createNewProfile()">+ ADD PROFILE</button>
        </div>
    </div>

    <div id="identityConsole" style="position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 2500; display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px);">
        <div class="card">
            <h2 style="font-family:'Cinzel'; color:var(--gold)">IDENTITY SEAL</h2>
            <div onclick="document.getElementById('passportFile').click()" style="width: 100px; height: 100px; border: 2px dashed var(--gold); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer;">
                <img id="passportPreview" src="" style="display:none; width:100%; height:100%; object-fit:cover;">
                <i id="upIcon" class="fas fa-camera" style="color:var(--gold)"></i>
            </div>
            <input type="file" id="passportFile" accept="image/*" style="display:none" onchange="processPassport(this)">
            <input type="tel" id="userPhoneReg" placeholder="PHONE (+234...)">
            <button class="btn-gold" id="finalVerifyBtn" onclick="saveIdentityData()">INITIALIZE ACCOUNT</button>
            <p id="processMsg" style="font-size:0.6rem; color:var(--gold); display:none; margin-top:10px;">ENCRYPTING...</p>
        </div>
    </div>

    <div id="mainChat">
        <header class="app-header">
            <div style="display:flex; gap:10px;">
                <button onclick="window.location.href='index.html'" class="header-btn">
    <i class="fas fa-house"></i>
</button>
                <button onclick="toggleDarkMode()" id="themeBtn" class="header-btn"><i class="fas fa-moon"></i></button>
            </div>
            <span style="font-family:'Cinzel'; color:var(--gold); font-size:1.4rem;">INDEX</span>
            <div id="userBadge"></div>
        </header>
        <div class="user-list" id="activeStudents"></div>
    </div>

    <div id="dmOverlay">
        <header class="app-header">
            <button onclick="closeDM()" class="header-btn"><i class="fas fa-chevron-left"></i></button>
            <b id="dmTargetName">Username</b>
            <button id="callAction" class="circle-btn" style="width:35px; height:35px;"><i class="fas fa-phone"></i></button>
        </header>
        <div id="dmBox"></div>
        <div class="input-bar">
            <input type="text" id="dmInput" placeholder="Message...">
            <button class="circle-btn" onclick="sendPrivateMsg()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDPG58s4TtDy3QPWcWVmPflG91sE4pvdAE",
            authDomain: "dgmobilechat.firebaseapp.com",
            projectId: "dgmobilechat",
            storageBucket: "dgmobilechat.firebasestorage.app",
            messagingSenderId: "1026158969514",
            appId: "1:1026158969514:web:a25655005d2868ec6c46d3"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();

        let me = null, isLoginMode = true, activeRoomId = null, dmUnsub = null, passportDataURL = "";

        // --- NAVIGATION & UI ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById('mainChat').style.display = (id === 'mainChat') ? 'flex' : 'none';
            if(id !== 'mainChat') document.getElementById(id).classList.add('active-screen');
        }

        function verifyPin() {
            if(document.getElementById('appPin').value === "1231") showScreen('authScreen');
            else alert("WRONG PIN");
        }

        function toggleDarkMode() {
            const isDark = document.body.style.backgroundColor === 'rgb(15, 23, 42)';
            document.body.style.backgroundColor = isDark ? '#020617' : '#0f172a';
            document.getElementById('themeBtn').innerHTML = isDark ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
        }

        function goHome() {
            closeDM();
            showScreen('mainChat');
        }

        // --- AUTH & PROFILE ---
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('authTitle').innerText = isLoginMode ? "CAMPUS LOGIN" : "GMAIL REGISTRATION";
        }

        async function handleAuth() {
            const e = document.getElementById('authEmail').value, p = document.getElementById('authPass').value;
            try {
                if(isLoginMode) { await auth.signInWithEmailAndPassword(e, p); fetchProfiles(e); }
                else { await auth.createUserWithEmailAndPassword(e, p); showScreen('profileScreen'); }
            } catch (err) { alert(err.message); }
        }

        async function fetchProfiles(email) {
            const snap = await db.collection("users").where("email", "==", email).get();
            const list = document.getElementById('profileList'); list.innerHTML = "";
            if(snap.empty) { showScreen('profileScreen'); return; }
            snap.forEach(doc => {
                const p = doc.data();
                const d = document.createElement('div'); d.className = 'profile-item';
                d.innerHTML = `<img src="${p.avatar}" style="width:30px; border-radius:50%"> <span>@${p.username}</span>`;
                d.onclick = () => selectProfile(p);
                list.appendChild(d);
            });
            showScreen('profileScreen');
        }

        async function createNewProfile() {
            const u = document.getElementById('newUsername').value, e = document.getElementById('authEmail').value;
            if(!u) return;
            const pData = { username: u, email: e, avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${u}`, phone: "", passport: "" };
            await db.collection("users").doc(u).set(pData);
            selectProfile(pData);
        }

        function selectProfile(profile) {
            me = profile;
            if (!me.passport || !me.phone) {
                document.getElementById('identityConsole').style.display = 'flex';
            } else {
                enterMainApp();
            }
        }

        function enterMainApp() {
            document.getElementById('profileScreen').classList.remove('active-screen');
            document.getElementById('identityConsole').style.display = 'none';
            document.getElementById('mainChat').style.display = 'flex';
            document.getElementById('userBadge').innerHTML = `<img src="${me.avatar}" style="width:35px; border-radius:50%">`;
            loadUsers();
        }

        // --- IDENTITY LOGIC ---
        function processPassport(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('passportPreview').src = e.target.result;
                    document.getElementById('passportPreview').style.display = 'block';
                    document.getElementById('upIcon').style.display = 'none';
                    passportDataURL = e.target.result; 
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function saveIdentityData() {
            const phone = document.getElementById('userPhoneReg').value;
            const btn = document.getElementById('finalVerifyBtn');
            if (!phone || !passportDataURL) return alert("All fields mandatory");
            btn.disabled = true; btn.innerText = "INITIALIZING...";

            try {
                await db.collection("users").doc(me.username).update({ phone: phone, passport: passportDataURL });
                me.phone = phone; me.passport = passportDataURL;
                enterMainApp();
            } catch (err) { alert(err.message); btn.disabled = false; }
        }

        // --- CHAT LOGIC ---
        function loadUsers() {
            db.collection("users").onSnapshot(snap => {
                const list = document.getElementById('activeStudents'); list.innerHTML = "";
                snap.forEach(doc => {
                    const u = doc.data(); if(u.username === me.username) return;
                    list.innerHTML += `<div class="user-row" onclick="openDM('${u.username}', '${u.avatar}', '${u.phone}')">
                        <img src="${u.avatar}" style="width:45px; border-radius:50%">
                        <b>${u.username}</b></div>`;
                });
            });
        }

        function openDM(user, avatar, phone) {
            document.getElementById('dmOverlay').style.display = 'flex';
            document.getElementById('dmTargetName').innerText = user;
            activeRoomId = [me.username, user].sort().join("__");
            document.getElementById('callAction').onclick = () => window.location.href = `tel:${phone}`;
            listenMessages();
        }

        function closeDM() { 
            document.getElementById('dmOverlay').style.display = 'none'; 
            if(dmUnsub) dmUnsub();
        }

        function sendPrivateMsg() {
            const txt = document.getElementById('dmInput').value; if(!txt) return;
            db.collection("pvt_rooms").doc(activeRoomId).collection("messages").add({
                text: txt, sender: me.username, timestamp: Date.now()
            });
            document.getElementById('dmInput').value = "";
        }

        function listenMessages() {
            dmUnsub = db.collection("pvt_rooms").doc(activeRoomId).collection("messages").orderBy("timestamp", "asc").onSnapshot(snap => {
                const box = document.getElementById('dmBox'); box.innerHTML = "";
                snap.forEach(doc => {
                    const m = doc.data(); const isMe = m.sender === me.username;
                    box.innerHTML += `<div class="msg ${isMe ? 'sent' : 'received'}">${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }
    </script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>INDEX | Integrated Elite</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600&family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');


        :root { --gold: #d4af37; --bg: #020617; --glass: rgba(255, 255, 255, 0.03); --border: rgba(212, 175, 55, 0.15); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Poppins', sans-serif;}
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #e2e8f0; overflow: hidden; transition: background 0.5s; }

        .screen { position: fixed; inset: 0; display: none; flex-direction: column; background: var(--bg); z-index: 100; padding: 30px; }
        .active-screen { display: flex; align-items: center; justify-content: center; }

        .card { background: #000; border: 1px solid var(--gold); padding: 30px; border-radius: 20px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 0 30px rgba(212, 175, 55, 0.1); }
        input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(255,255,255,0.03); color: white; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--gold); }
        .btn-gold { background: linear-gradient(90deg, #d4af37, #f5d17a); color: black; border: none; padding: 15px; border-radius: 12px; font-weight: 800; cursor: pointer; width: 100%; text-transform: uppercase; }

        /* User List & Search */
        .search-container { padding: 10px 20px; background: rgba(0,0,0,0.2); }
        .search-bar { width: 100%; padding: 10px 15px; border-radius: 10px; border: 1px solid var(--border); background: var(--glass); color: white; font-size: 0.8rem; }
        
        .user-list { flex: 1; overflow-y: auto; padding: 20px; }
        .user-row { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--glass); border-radius: 18px; margin-bottom: 10px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .user-row:hover { border-color: var(--gold); background: rgba(212, 175, 55, 0.05); }

        /* Profile Selection */
        .profile-list { width: 100%; max-height: 200px; overflow-y: auto; margin: 15px 0; }
        .profile-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--glass); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 8px; cursor: pointer; }

        /* App Header */
        .app-header { padding: 50px 20px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .header-btn { background: var(--glass); border: 1px solid var(--border); color: var(--gold); width: 40px; height: 40px; border-radius: 10px; cursor: pointer; }

        /* DM Overlay */
        #dmOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: none; flex-direction: column; }
        #dmBox { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 12px 16px; border-radius: 20px; position: relative; font-size: 0.9rem; }
        .sent { align-self: flex-end; background: var(--gold); color: black; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: var(--glass); border: 1px solid var(--border); border-bottom-left-radius: 2px; }
        .input-bar { padding: 15px 20px 40px; display: flex; gap: 10px; background: rgba(0,0,0,0.6); }
        .circle-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--gold); border: none; cursor: pointer; }
    
    
    </style>
</head>
<body>
    <nav>
        <button onclick="window.location.href='second.html'" class="header-btn" style="position: fixed; top: 20px; left: 20px; z-index:3000;"><i class="fas fa-home"></i></button>
        <button onclick="toggleDarkMode()" id="themeBtn" class="header-btn" style="position: fixed; top: 20px; right: 20px; z-index:3000;"><i class="fas fa-moon"></i></button>
        <button onclick="window.location.href='index.html'" class="btn-primary" style="position: fixed; top: 70px; right: 20px; z-index:3000;"><i class="fas fa-globe"></i></button>

    </nav>
    <div id="appContainer">

    <div id="pinScreen" class="screen active-screen" style="color: white; padding: 20px;">
        <div class="card">
            <h1 style="font-family:'Cinzel'; color:var(--gold)"> APP ACCESS </h1>
            <input type="password" id="appPin" placeholder="ENTER PIN" maxlength="20" style="text-align:center; font-size:1.5rem;">
            <button class="btn-gold" onclick="verifyPin()"> Create Your Profile </button>
        </div>
    </div>

    <div id="authScreen" class="screen">
        <div class="card">
            <h2 id="authTitle" style="color:var(--gold)"> ACCOUNT LOGIN</h2>
            <input type="email" id="authEmail" placeholder="GMAIL">
            <input type="password" id="authPass" placeholder="PASSWORD">
            <button class="btn-gold" onclick="handleAuth()"> ACCESS YOUR PROFILE (s) </button>
            <p onclick="toggleAuthMode()" id="toggleText" style="font-size:0.8rem; color:var(--gold); margin-top:15px; cursor:pointer;">New Student? Register</p>
        </div>
    </div>

    <div id="profileScreen" class="screen">
        <div class="card">
            <h2 style="color:var(--gold)">IDENTITIES</h2>
            <div id="profileList" class="profile-list"></div>
            <input type="text" id="newUsername" placeholder="NEW USERNAME">
            <button class="btn-gold" onclick="createNewProfile()">+ ADD IMAGE </button>
        </div>
    </div>

    <div id="identityConsole" style="position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 2500; display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px);">
        <div class="card">
            <h2 style="font-family:'Cinzel'; color:var(--gold)">IDENTITY SEAL</h2>
            <div onclick="document.getElementById('passportFile').click()" style="width: 100px; height: 100px; border: 2px dashed var(--gold); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer;">
                <img id="passportPreview" src="" style="display:none; width:100%; height:100%; object-fit:cover;">
                <i id="upIcon" class="fas fa-camera" style="color:var(--gold)"></i>
            </div>
            <input type="file" id="passportFile" accept="image/*" style="display:none" onchange="processPassport(this)">
            <input type="tel" id="userPhoneReg" placeholder="PHONE (+234...)">
            <button class="btn-gold" id="finalVerifyBtn" onclick="saveIdentityData()"> CREATE MY ACCOUNT</button>
            <p id="processMsg" style="font-size:0.6rem; color:var(--gold); display:none; margin-top:10px;"> Creating your new acount...</p>
        </div>
    </div>

    <div id="mainChat">
        
        <header style="color: white;" class="app-header"> 
            
            <div style="display:flex; gap:10px;">
                <button onclick="window.location.href='index.html'" class="header-btn"><i class="fas fa-house"></i></button>
                <button onclick="toggleDarkMode()" id="themeBtn" class="header-btn"><i class="fas fa-moon"></i></button>
            </div>
            <span style="font-family:'Cinzel'; color:var(--gold); font-size:1.4rem; margin-right: 70px;"> DOLP CHAT v2.1 </span>
            <div id="userBadge"></div>
        
        </header>
        
        <div>
        <div class="search-container">
            <input type="text" id="userSearch" class="search-bar" placeholder="Search student name..." onkeyup="filterUsers()">
        </div>

        <div class="user-list" id="activeStudents"></div>
    </div>
    </div>

    <div id="dmOverlay">
        <header class="app-header">
            <button onclick="closeDM()" class="header-btn"><i class="fas fa-chevron-left"></i></button>
            <b id="dmTargetName">Username</b>
            <button id="callAction" class="circle-btn" style="width:35px; height:35px;"><i class="fas fa-phone"></i></button>
        </header>
        <div id="dmBox"></div>
        <div class="input-bar">
            <input type="text" id="dmInput" placeholder="Message...">
            <button class="circle-btn" onclick="sendPrivateMsg()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

    <script>
        const firebaseConfig = {
            
  "type": "service_account",
  "project_id": "engaged-precept-483922-t4",
  "private_key_id": "f70a424d65a97a6e5d0a9e8903cce0aaf5dacda2",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDBUN2cDYFrjopl\nc5SbRj86ClT7ewEdy42kdJ/i+i5sAw1VcbgwqruVtbmPTpppkPoMy9/SX61LCMVo\n0t7+H4w/I8545jEpVDnb33kKIulLfE/COJAsJ95sphbAwHDxeuKqOpS9cVd9oNDA\n46Z3A7SgA2+6/p++6QjUFlG0H8ZZss+ZKemNdCGYvC5aTyNnntWRHQfl23yBLDK+\n+UGQN1MAJ+Z5+fkmKc9etXY5Ip1pZlfxiGj+qSp+7aupkVSgfPp/1Qg3c9Ksxdwq\nsHYiehdEgCINSdFWsmfcH3kJZKisHcOustqEiNol74EsEAFYEEwbGWTJv1BnD6Pg\nxWUNYeMZAgMBAAECggEAS+q+7M7c+WlD7m2CeawPnnJ6RzxaBuJuYJwwQgnv+xkD\nvn9nTy1td3CjS6UZvMVjfWz/G/XY7zOlmvHdAr1O7WjZZ982hT1/b1qGhTWKmstZ\n4zMlY0HQ9qgPHWk1sY+JvkI9MVx2eG6ULHv6XpjE8WYIFc5y251WizusoGkuEwEY\nDW4anhWtJMuuSr3JlMog9GfHylOOKkaAtFifr5ud3mm3aHC4YF8D0qGY78TSh1t7\nIhM3vuHKVPgtI1DJhk9mrm4fEbmjnlUN4wR4Ko1PlFdPLfEbOQC7gUS5E8hrF63t\nTY1KhXRaEwy2tsSsU39ZZlYEINz9a5ijej2pcfk+1QKBgQDe9tbSWFhtpts1mmUn\ngazuxeVLZd3RZ4lxbIsV0kKudLOPMhRi4wHs80wSNBtE0Vt2gBu2m8/IHsOwIpkT\nI/ZzuKyaaukxqfPmJgTEyCz08Qp3KttS8XvuCyHUADDF9NETLYJ8fY9vO61feJ+l\nA4zE74bd3L3e95rTNu61tqaDXwKBgQDd9XK7GTbsyTLAzgmhorARAKoSju/8lfQr\nb4V5z9jMCHrCJbp4M8i93mRkS2UAe9A/30XyLHwXZjdt8zD726rFyFBPe5ZxOh4U\n2j6BWXN6QkhdYHRPmsvmrwpLJFes4hSXAZ2fM3Uezu/I4aXS2BzeUSWqPO/LcqOB\nJnC+XK7khwKBgGdMXyym55kts+O6u2C5UIBzSQ9Mi59H48Kb8jhS6Lfgs4wFPLKv\nz6WS9sx8PaH9iO123uAUggiKUElbTiYzBCyLA9Sq8Y0j2y7msFDnGQUGY73gKirc\nXHllyO9qgy5DhVXoQMsidQCo2mMgBH60DVT0UDyb14/kkWOH0MJ5c93rAoGAQfbR\nOyOaPDLrX3ucRypHczYkVVGfpwyVvVbuby5DOxgGC68UxOZ28V6nrVru0H77fBAK\nBJgN5RJexNFyrFczYIZQv9517n6cNAxMaTrBZANQ6FdjGclicdNxlrVdTSb/gYVc\nZ9TuKNLNVoEhPBE4OyYYsIhdp7QRPa/D7/8xhv8CgYEA3DrRZKEoGkU02IXyYPrn\nGcNgnpUWij+nkXfmkctwXI/w5GalF62b3OoqaAmzfCM6bZE9BGsRYzWbwH2HPKIQ\n78sfhmS/olQk3lT71yoc9MLfxUN6rLSW4Yosc6BBbeVr13GhQkSB7TWv1nLo9eZN\nyfPRLFIWU9KJopUTxFVU33k=\n-----END PRIVATE KEY-----\n",
  "client_email": "dg-chat@engaged-precept-483922-t4.iam.gserviceaccount.com",
  "client_id": "101338968947587188684",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/dg-chat%40engaged-precept-483922-t4.iam.gserviceaccount.com",
  "universe_domain": "googleapis.com",
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();

        let me = null, isLoginMode = true, activeRoomId = null, dmUnsub = null, passportDataURL = "";

        // --- SEARCH LOGIC ---
        function filterUsers() {
            const query = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.querySelectorAll('.user-row');
            rows.forEach(row => {
                const name = row.querySelector('b').innerText.toLowerCase();
                row.style.display = name.includes(query) ? 'flex' : 'none';
            });
        }

        // --- UI & NAVIGATION ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById('mainChat').style.display = (id === 'mainChat') ? 'flex' : 'none';
            if(id !== 'mainChat') document.getElementById(id).classList.add('active-screen');
        }

        function verifyPin() {
            if(document.getElementById('appPin').value === "1") showScreen('authScreen');
            else alert("What is this PIN? Hehe, thats wrong!");
        }

        function toggleDarkMode() {
            const isDark = document.body.style.backgroundColor === 'rgb(15, 23, 42)';
            document.body.style.backgroundColor = isDark ? '#020617' : '#0f172a';
            document.getElementById('themeBtn').innerHTML = isDark ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('authTitle').innerText = isLoginMode ? "CAMPUS LOGIN" : "GMAIL REGISTRATION";
        }

        async function handleAuth() {
            const e = document.getElementById('authEmail').value, p = document.getElementById('authPass').value;
            try {
                if(isLoginMode) { await auth.signInWithEmailAndPassword(e, p); fetchProfiles(e); }
                else { await auth.createUserWithEmailAndPassword(e, p); showScreen('profileScreen'); }
            } catch (err) { alert(err.message); }
        }

        async function fetchProfiles(email) {
            const snap = await db.collection("users").where("email", "==", email).get();
            const list = document.getElementById('profileList'); list.innerHTML = "";
            if(snap.empty) { showScreen('profileScreen'); return; }
            snap.forEach(doc => {
                const p = doc.data();
                const d = document.createElement('div'); d.className = 'profile-item';
                d.innerHTML = `<img src="${p.avatar}" style="width:30px; border-radius:50%"> <span>@${p.username}</span>`;
                d.onclick = () => selectProfile(p);
                list.appendChild(d);
            });
            showScreen('profileScreen');
        }

        async function createNewProfile() {
            const u = document.getElementById('newUsername').value, e = document.getElementById('authEmail').value;
            if(!u) return;
            const pData = { username: u, email: e, avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${u}`, phone: "", passport: "" };
            await db.collection("users").doc(u).set(pData);
            selectProfile(pData);
        }

        function selectProfile(profile) {
            me = profile;
            if (!me.passport || !me.phone) {
                document.getElementById('identityConsole').style.display = 'flex';
            } else {
                enterMainApp();
            }
        }

        function enterMainApp() {
            document.getElementById('profileScreen').classList.remove('active-screen');
            document.getElementById('identityConsole').style.display = 'none';
            document.getElementById('mainChat').style.display = 'flex';
            document.getElementById('userBadge').innerHTML = `<img src="${me.avatar}" style="width:35px; border-radius:50%">`;
            loadUsers();
        }

        function processPassport(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('passportPreview').src = e.target.result;
                    document.getElementById('passportPreview').style.display = 'block';
                    document.getElementById('upIcon').style.display = 'none';
                    passportDataURL = e.target.result; 
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function saveIdentityData() {
            const phone = document.getElementById('userPhoneReg').value;
            const btn = document.getElementById('finalVerifyBtn');
            if (!phone || !passportDataURL) return alert("All fields mandatory");
            btn.disabled = true; btn.innerText = "INITIALIZING...";
            try {
                await db.collection("users").doc(me.username).update({ phone: phone, passport: passportDataURL });
                me.phone = phone; me.passport = passportDataURL;
                enterMainApp();
            } catch (err) { alert(err.message); btn.disabled = false; }
        }

        function loadUsers() {
            db.collection("users").onSnapshot(snap => {
                const list = document.getElementById('activeStudents'); list.innerHTML = "";
                snap.forEach(doc => {
                    const u = doc.data(); if(u.username === me.username) return;
                    list.innerHTML += `<div class="user-row" onclick="openDM('${u.username}', '${u.avatar}', '${u.phone}')">
                        <img src="${u.avatar}" style="width:45px; border-radius:50%">
                        <b>${u.username}</b></div>`;
                });
                filterUsers(); // Re-apply filter if data updates
            });
        }

        function openDM(user, avatar, phone) {
            document.getElementById('dmOverlay').style.display = 'flex';
            document.getElementById('dmTargetName').innerText = user;
            activeRoomId = [me.username, user].sort().join("__");
            document.getElementById('callAction').onclick = () => window.location.href = `tel:${phone}`;
            listenMessages();
        }

        function closeDM() { 
            document.getElementById('dmOverlay').style.display = 'none'; 
            if(dmUnsub) dmUnsub();
        }

        function sendPrivateMsg() {
            const txt = document.getElementById('dmInput').value; if(!txt) return;
            db.collection("pvt_rooms").doc(activeRoomId).collection("messages").add({
                text: txt, sender: me.username, timestamp: Date.now()
            });
            document.getElementById('dmInput').value = "";
        }

        function listenMessages() {
            dmUnsub = db.collection("pvt_rooms").doc(activeRoomId).collection("messages").orderBy("timestamp", "asc").onSnapshot(snap => {
                const box = document.getElementById('dmBox'); box.innerHTML = "";
                snap.forEach(doc => {
                    const m = doc.data(); const isMe = m.sender === me.username;
                    box.innerHTML += `<div class="msg ${isMe ? 'sent' : 'received'}">${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }
    </script>
</body>
</html>